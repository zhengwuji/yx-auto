# Cloudflare Workers 服务器优选工具 - 完整使用说明

## 📋 目录

1. [项目简介](#项目简介)
2. [功能特性](#功能特性)
3. [环境变量配置](#环境变量配置)
4. [部署步骤](#部署步骤)
5. [使用指南](#使用指南)
6. [API 接口说明](#api-接口说明)
7. [订阅链接格式](#订阅链接格式)
8. [安全说明](#安全说明)
9. [常见问题](#常见问题)
10. [故障排除](#故障排除)

---

## 📖 项目简介

这是一个基于 Cloudflare Workers 的服务器优选工具，支持自动优选 Cloudflare IP、域名和 GitHub IP，并生成 VLESS、Trojan、VMess 协议的订阅链接。工具提供了完整的访问控制和会话管理功能。

### 主要特点

- ✅ **自动优选**：支持优选域名、优选IP、GitHub IP
- ✅ **多协议支持**：VLESS、Trojan、VMess
- ✅ **访问控制**：基于密码的登录验证和会话管理
- ✅ **订阅安全**：使用 Token 验证订阅链接访问
- ✅ **防暴力破解**：内置登录失败保护机制
- ✅ **统计功能**：访问统计和访问者IP记录

---

## 🎯 功能特性

### 1. 优选功能

- **优选域名**：使用预设的优选域名列表
- **优选IP**：从 wetest 或自定义URL获取最优IP
- **GitHub IP**：自动获取 GitHub 可用IP

### 2. 协议支持

- **VLESS**：默认启用
- **Trojan**：可选启用
- **VMess**：可选启用

### 3. 访问控制

- **登录验证**：使用 `ADMIN_PASSWORD` 进行身份验证
- **会话管理**：使用 `SESSION_SECRET` 签名 Cookie
- **订阅Token**：每次获取订阅链接需要有效 Token

### 4. 统计功能

- 订阅访问统计
- 访问者IP记录
- KV存储使用量监控

---

## ⚙️ 环境变量配置

在 Cloudflare Workers Dashboard 中配置以下环境变量：

### 必需环境变量

#### 1. `ADMIN_PASSWORD`
- **用途**：管理员登录密码
- **说明**：用于登录页面的密码验证
- **示例**：`MySecurePassword123!`
- **安全建议**：使用强密码（至少12位，包含大小写字母、数字和特殊字符）

#### 2. `SESSION_SECRET`
- **用途**：会话密钥，用于签名 Cookie 和生成订阅 Token
- **说明**：用于确保会话 Cookie 和订阅链接的安全性
- **示例**：`a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6`
- **安全建议**：使用随机生成的32位以上字符串，不要与 `ADMIN_PASSWORD` 相同

### 可选环境变量

#### 3. `yxURL` 或 `YXURL`
- **用途**：自定义优选IP来源URL
- **说明**：如果不设置，将使用默认的 wetest API
- **示例**：`https://your-custom-api.com/ips`

#### 4. `scu`
- **用途**：订阅转换服务地址
- **说明**：用于生成 Clash 等格式的订阅
- **默认值**：`https://url.v1.mk/sub`

#### 5. `AUTH_KV`（可选）
- **用途**：KV存储绑定名称
- **说明**：用于存储访问记录和防暴力破解数据
- **配置方法**：在 Workers 设置中绑定 KV Namespace

---

## 🚀 部署步骤

### 步骤 1：创建 Cloudflare Worker

1. 登录 [Cloudflare Dashboard](https://dash.cloudflare.com/)
2. 进入 **Workers & Pages**
3. 点击 **Create application** → **Create Worker**
4. 输入 Worker 名称（例如：`server-optimizer`）
5. 点击 **Deploy**

### 步骤 2：上传代码

1. 在 Worker 编辑页面，点击 **Quick edit**
2. 删除默认代码
3. 复制 `服务器优选工具 - 简化版.js` 的全部内容
4. 粘贴到编辑器中
5. 点击 **Save and deploy**

### 步骤 3：配置环境变量

1. 在 Worker 页面，点击 **Settings** 标签
2. 滚动到 **Environment Variables** 部分
3. 点击 **Add variable**，添加以下变量：

   ```
   变量名: ADMIN_PASSWORD
   值: [您的登录密码]
   ```

   ```
   变量名: SESSION_SECRET
   值: [您的会话密钥，建议使用随机生成的长字符串]
   ```

4. 点击 **Save**

### 步骤 4：配置 KV 存储（可选但推荐）

1. 在 Workers 页面，点击 **KV** 标签
2. 点击 **Create a namespace**
3. 输入名称（例如：`auth-kv`）
4. 创建后，返回 Worker 的 **Settings** 页面
5. 在 **KV Namespace Bindings** 部分，点击 **Add binding**
6. 设置：
   - **Variable name**: `AUTH_KV`
   - **KV namespace**: 选择刚创建的 namespace
7. 点击 **Save**

### 步骤 5：配置自定义域名（可选）

1. 在 Worker 页面，点击 **Triggers** 标签
2. 在 **Custom Domains** 部分，点击 **Add Custom Domain**
3. 输入您的域名
4. 按照提示完成 DNS 配置

### 步骤 6：测试部署

1. 访问您的 Worker URL（格式：`https://your-worker.your-subdomain.workers.dev`）
2. 应该看到登录页面
3. 使用 `ADMIN_PASSWORD` 登录
4. 验证功能是否正常

---

## 📚 使用指南

### 登录系统

1. 访问 Worker 的根路径（`/`）
2. 如果未登录，会自动跳转到登录页面（`/login`）
3. 输入 `ADMIN_PASSWORD` 设置的密码
4. 点击登录
5. 登录成功后，会话 Cookie 有效期为 24 小时

### 生成订阅链接

1. **登录后访问主页**
   - 在主页上会显示订阅链接生成表单

2. **填写配置信息**
   - **UUID**：输入您的 VLESS/Trojan UUID
   - **域名**：输入用于生成节点的域名
   - **协议选择**：选择 VLESS、Trojan 或 VMess
   - **优选选项**：
     - ✅ 启用优选域名
     - ✅ 启用优选IP
     - ✅ 启用GitHub优选
   - **IP类型**：选择 IPv4 和/或 IPv6
   - **运营商**：选择移动、联通、电信
   - **TLS控制**：是否禁用非TLS连接
   - **自定义路径**：WebSocket 路径（默认 `/`）

3. **生成订阅链接**
   - 点击生成按钮
   - 订阅链接会自动包含 Token 参数
   - 复制链接到您的客户端使用

### 退出登录

- 点击页面上的 **退出登录** 按钮
- 或访问 `/logout` 路径

---

## 🔌 API 接口说明

### 1. 主页
- **路径**：`/`
- **方法**：`GET`
- **说明**：显示订阅链接生成界面
- **认证**：需要登录（Cookie 验证）

### 2. 登录页面
- **路径**：`/login`
- **方法**：`GET` / `POST`
- **说明**：
  - `GET`：显示登录表单
  - `POST`：提交登录信息
- **POST 参数**：
  - `password`：登录密码

### 3. 退出登录
- **路径**：`/logout`
- **方法**：`GET`
- **说明**：清除会话 Cookie 并重定向到登录页

### 4. 订阅接口
- **路径**：`/{UUID}/sub`
- **方法**：`GET`
- **说明**：获取订阅内容
- **认证**：需要 Token 验证
- **URL 参数**：
  - `domain`：节点域名（必需）
  - `token`：订阅 Token（必需，由系统自动生成）
  - `epd`：启用优选域名（`yes`/`no`，默认 `yes`）
  - `epi`：启用优选IP（`yes`/`no`，默认 `yes`）
  - `egi`：启用GitHub优选（`yes`/`no`，默认 `yes`）
  - `ev`：启用VLESS协议（`yes`/`no`，默认 `yes`）
  - `et`：启用Trojan协议（`yes`/`no`，默认 `no`）
  - `vm`：启用VMess协议（`yes`/`no`，默认 `no`）
  - `ipv4`：启用IPv4（`yes`/`no`，默认 `yes`）
  - `ipv6`：启用IPv6（`yes`/`no`，默认 `yes`）
  - `ispMobile`：移动运营商（`yes`/`no`，默认 `yes`）
  - `ispUnicom`：联通运营商（`yes`/`no`，默认 `yes`）
  - `ispTelecom`：电信运营商（`yes`/`no`，默认 `yes`）
  - `dkby`：禁用非TLS（`yes`/`no`，默认 `no`）
  - `path`：自定义路径（默认 `/`）
  - `target`：订阅格式（`base64`/`clash`/`clashr`，默认 `base64`）

### 5. 统计API
- **路径**：`/api/stats`
- **方法**：`GET`
- **说明**：获取订阅访问统计信息
- **认证**：需要登录
- **返回格式**：JSON
- **返回字段**：
  - `totalAccess`：总访问次数
  - `generatedCount`：生成的订阅数
  - `activeCount`：活跃订阅数
  - `ipList`：访问IP列表

### 6. 访问者IP API
- **路径**：`/api/visitors`
- **方法**：`GET`
- **说明**：获取访问者IP和KV使用量
- **认证**：需要登录
- **返回格式**：JSON
- **返回字段**：
  - `visitorIPs`：访问者IP列表
  - `totalVisitorIPs`：总访问者IP数
  - `kvUsageMB`：KV使用量（MB）
  - `kvUsageBytes`：KV使用量（字节）

---

## 🔗 订阅链接格式

### 完整订阅链接示例

```
https://your-worker.workers.dev/{UUID}/sub?domain=example.com&token=xxx&epd=yes&epi=yes&egi=yes&ev=yes&ipv4=yes&ipv6=yes
```

### 参数说明

| 参数 | 说明 | 可选值 | 默认值 |
|------|------|--------|--------|
| `domain` | 节点域名 | 任意有效域名 | 必需 |
| `token` | 订阅Token | 系统生成 | 必需 |
| `epd` | 启用优选域名 | `yes`/`no` | `yes` |
| `epi` | 启用优选IP | `yes`/`no` | `yes` |
| `egi` | 启用GitHub优选 | `yes`/`no` | `yes` |
| `ev` | 启用VLESS | `yes`/`no` | `yes` |
| `et` | 启用Trojan | `yes`/`no` | `no` |
| `vm` | 启用VMess | `yes`/`no` | `no` |
| `ipv4` | 启用IPv4 | `yes`/`no` | `yes` |
| `ipv6` | 启用IPv6 | `yes`/`no` | `yes` |
| `ispMobile` | 移动运营商 | `yes`/`no` | `yes` |
| `ispUnicom` | 联通运营商 | `yes`/`no` | `yes` |
| `ispTelecom` | 电信运营商 | `yes`/`no` | `yes` |
| `dkby` | 禁用非TLS | `yes`/`no` | `no` |
| `path` | 自定义路径 | 任意路径 | `/` |
| `target` | 订阅格式 | `base64`/`clash`/`clashr` | `base64` |

---

## 🔒 安全说明

### 1. 密码安全

- **`ADMIN_PASSWORD`** 用于登录验证
- 建议使用强密码（至少12位）
- 定期更换密码
- 不要在代码中硬编码密码

### 2. 会话安全

- **`SESSION_SECRET`** 用于签名 Cookie 和生成订阅 Token
- 必须使用随机生成的强密钥
- 不要与 `ADMIN_PASSWORD` 相同
- 泄露后应立即更换

### 3. 订阅Token

- 订阅 Token 基于 `SESSION_SECRET` 生成
- Token 永久有效（除非更换 `SESSION_SECRET`）
- 每次登录后生成的 Token 相同
- 更换 `SESSION_SECRET` 后，所有旧 Token 将失效

### 4. 防暴力破解

- 系统内置防暴力破解保护
- 同一IP连续失败5次后，锁定15分钟
- 使用 KV 存储记录失败尝试（如果配置了 `AUTH_KV`）

### 5. Cookie 安全

- 会话 Cookie 使用 `HttpOnly` 标志，防止 XSS 攻击
- 使用 `SameSite=Lax` 防止 CSRF 攻击
- Cookie 有效期24小时
- 使用 `SESSION_SECRET` 签名，防止篡改

### 6. 最佳实践

1. **定期更换密钥**：建议每3-6个月更换 `SESSION_SECRET`
2. **监控访问日志**：定期检查访问者IP和统计信息
3. **使用HTTPS**：确保 Worker 使用 HTTPS（Cloudflare 默认提供）
4. **限制访问**：考虑使用 Cloudflare Access 进一步限制访问
5. **备份配置**：记录环境变量值（安全存储）

---

## ❓ 常见问题

### Q1: 如何生成强密码和会话密钥？

**生成 `ADMIN_PASSWORD`：**
```bash
# Linux/Mac
openssl rand -base64 24

# 或使用在线工具生成强密码
```

**生成 `SESSION_SECRET`：**
```bash
# Linux/Mac
openssl rand -hex 32

# 或使用 Node.js
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
```

### Q2: 忘记密码怎么办？

1. 在 Cloudflare Dashboard 中修改 `ADMIN_PASSWORD` 环境变量
2. 保存并重新部署 Worker
3. 使用新密码登录

### Q3: 订阅链接提示 Token 无效？

可能原因：
1. `SESSION_SECRET` 已更改，需要重新生成订阅链接
2. Token 参数缺失或格式错误
3. 订阅链接已过期（如果系统有设置过期时间）

解决方法：
1. 重新登录系统
2. 在主页重新生成订阅链接
3. 检查 URL 中的 `token` 参数是否正确

### Q4: 如何查看访问统计？

1. 登录系统
2. 访问主页，页面会自动显示统计信息
3. 或直接访问 `/api/stats` API 端点

### Q5: 如何清除访问记录？

如果配置了 KV 存储：
1. 在 Cloudflare Dashboard 中进入 KV Namespace
2. 手动删除相关键值
3. 或等待自动过期（如果设置了过期时间）

### Q6: 订阅链接无法访问？

检查清单：
1. ✅ Worker 是否正常部署
2. ✅ 环境变量是否正确配置
3. ✅ Token 参数是否存在且正确
4. ✅ UUID 格式是否正确
5. ✅ 域名参数是否提供
6. ✅ 网络连接是否正常

### Q7: 如何自定义优选IP来源？

1. 在环境变量中设置 `yxURL` 或 `YXURL`
2. 确保URL返回的格式与默认API兼容
3. 或在订阅链接中使用 `yxURL` 参数

### Q8: 支持哪些订阅格式？

- **base64**：标准 Base64 编码（默认）
- **clash**：Clash 配置格式
- **clashr**：ClashR 配置格式

### Q9: 会话过期后怎么办？

会话 Cookie 有效期为 24 小时，过期后：
1. 系统会自动跳转到登录页面
2. 重新输入密码登录即可
3. 订阅链接不受影响（使用 Token 验证）

### Q10: 如何禁用访问控制？

**不推荐**，但如果需要：
1. 不设置 `ADMIN_PASSWORD` 环境变量
2. 不设置 `SESSION_SECRET` 环境变量
3. 系统将允许无密码访问

**⚠️ 警告**：禁用访问控制后，任何人都可以访问和生成订阅链接！

---

## 🔧 故障排除

### 问题1：Worker 部署失败

**可能原因：**
- 代码语法错误
- 文件过大（超过 1MB）

**解决方法：**
1. 检查代码语法
2. 使用 Cloudflare Wrangler CLI 部署
3. 检查 Worker 配额限制

### 问题2：登录后立即退出

**可能原因：**
- `SESSION_SECRET` 未设置或格式错误
- Cookie 设置失败

**解决方法：**
1. 检查 `SESSION_SECRET` 是否正确配置
2. 清除浏览器 Cookie 后重试
3. 检查浏览器是否允许 Cookie

### 问题3：订阅链接返回空内容

**可能原因：**
- 优选IP获取失败
- 网络连接问题
- API 限制

**解决方法：**
1. 检查网络连接
2. 尝试禁用部分优选选项
3. 检查优选IP API 是否可访问

### 问题4：统计信息不准确

**可能原因：**
- KV 存储未配置
- 数据未正确写入

**解决方法：**
1. 确认 `AUTH_KV` 已正确绑定
2. 检查 KV 存储配额
3. 查看 Worker 日志

### 问题5：防暴力破解不工作

**可能原因：**
- `AUTH_KV` 未配置
- KV 存储配额已满

**解决方法：**
1. 配置 `AUTH_KV` KV Namespace
2. 检查 KV 存储使用量
3. 清理过期数据

---

## 📝 更新日志

### 版本说明

- **当前版本**：简化版
- **主要功能**：优选域名、优选IP、GitHub优选、节点生成
- **安全特性**：基于环境变量的密码验证和会话管理

### 变更记录

- ✅ 使用 `ADMIN_PASSWORD` 替代 `LOGIN_PASSWORD`
- ✅ 新增 `SESSION_SECRET` 用于签名 Cookie 和订阅 Token
- ✅ 改进会话验证机制
- ✅ 优化订阅 Token 生成逻辑

---

## 📞 技术支持

如遇到问题，请检查：

1. **Cloudflare Workers 文档**：https://developers.cloudflare.com/workers/
2. **Worker 日志**：在 Dashboard 中查看实时日志
3. **环境变量配置**：确认所有必需变量已正确设置

---

## 📄 许可证

本项目仅供学习和个人使用。

---

## ⚠️ 免责声明

本工具仅供技术研究和合法用途使用。使用者需遵守当地法律法规，不得用于任何非法活动。作者不对使用本工具造成的任何后果负责。

---

**最后更新**：2024年

**文档版本**：1.0
